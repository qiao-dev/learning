<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’“é±¼é‚®ä»¶å®‰å…¨çŸ¥è¯†åŸ¹è®­</title>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        /* æ­¥éª¤æŒ‰é’®æ ·å¼ */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0 10px;
            gap: 5px;
        }
        
        .step {
            flex: 1;
            padding: 10px 5px;
            background-color: #dcdfe6;
            border-radius: 20px;
            color: #c0c4cc;
            cursor: not-allowed;
            transition: all 0.3s;
            text-align: center;
            line-height: 1.4;
        }
        
        .step.active {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        
        .step.completed {
            background-color: #3498db;
            color: white;
            cursor: pointer;
        }
        
        /* æ•´ä½“è¿›åº¦æ¡ */
        .overall-progress-area {
            margin: 15px 0;
        }
        
        .overall-progress-text {
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .overall-progress {
            height: 8px;
            background-color: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .overall-progress-bar {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* è§†é¢‘åŒºåŸŸ */
        .video-section {
            margin-bottom: 20px;
        }
        
        .video-container {
            width: 100%;
            height: 450px;
            margin: 10px 0;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* è§†é¢‘æ“ä½œæŒ‰é’® */
        .action-buttons {
            display: none;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            gap: 10px;
            z-index: 5;
        }
        
        .action-buttons.show {
            display: flex;
        }
        
        .action-btn {
            padding: 10px 20px;
            background-color: #3498db;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .action-btn.secondary {
            background-color: #f39c12;
        }
        
        /* ç­”é¢˜å¼¹çª— */
        .question-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            color: white;
        }
        
        .question-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .question-title {
            font-size: 18px;
            margin-bottom: 0;
            color: #3498db;
            flex: 1;
            margin-right: 15px;
        }
        
        .close-question-btn {
            background-color: #666;
            border: 1px solid #888;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .close-question-btn:hover {
            background-color: #888;
        }
        
        .question-content {
            background-color: #2c3e50;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
        }
        
        .options {
            margin: 20px 0;
        }
        
        .option {
            padding: 10px;
            margin: 10px 0;
            background-color: #34495e;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .option:hover {
            background-color: #4a6584;
        }
        
        .option.correct {
            background-color: #27ae60;
        }
        
        .option.incorrect {
            background-color: #e74c3c;
        }
        
        .btn {
            padding: 10px 20px;
            background-color: #3498db;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .retry-btn {
            background-color: #f39c12;
            margin-left: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        /* æ»¡æ„åº¦é—®å·æ ·å¼ */
        .survey-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        
        .survey-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .rating-section {
            margin: 20px 0;
        }
        
        .rating-label {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 10px;
            display: block;
        }
        
        .stars {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .star {
            font-size: 30px;
            color: #dcdfe6;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .star.active {
            color: #f39c12;
        }
        
        .comment-section {
            margin: 20px 0;
        }
        
        .comment-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #dcdfe6;
            border-radius: 5px;
            resize: vertical;
            min-height: 100px;
            font-size: 14px;
            font-family: "Microsoft YaHei", sans-serif;
        }
        
        .submit-survey-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .submit-survey-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .reset-progress-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            background-color: #e74c3c;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
    <!-- å¼•å…¥SPO JSOMæ ¸å¿ƒåº“ -->
    <script src="/_layouts/15/SP.Runtime.js"></script>
    <script src="/_layouts/15/SP.js"></script>
</head>
<body>
    <button class="reset-progress-btn" onclick="resetProgress()">é‡ç½®å­¦ä¹ è¿›åº¦</button>
    
    <div class="container">
        <h1 class="title">é’“é±¼é‚®ä»¶å®‰å…¨çŸ¥è¯†åŸ¹è®­</h1>
        
        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="step-indicator">
            <div class="step active" id="step1" onclick="handleStepClick(1)">
                è§†é¢‘1<br>
                <span id="step1Progress">0%</span>
            </div>
            <div class="step" id="step2" onclick="handleStepClick(2)">
                è§†é¢‘2<br>
                <span id="step2Progress">0%</span>
            </div>
            <div class="step" id="step3" onclick="handleStepClick(3)">
                è§†é¢‘3<br>
                <span id="step3Progress">0%</span>
            </div>
            <div class="step" id="step4" onclick="handleStepClick(4)">
                è°ƒæŸ¥é—®å·<br>
                <span id="step4Progress">0%</span>
            </div>
        </div>
        
        <!-- æ•´ä½“è¿›åº¦æ¡ -->
        <div class="overall-progress-area">
            <div class="overall-progress-text">æ•´ä½“åŸ¹è®­è¿›åº¦</div>
            <div class="overall-progress">
                <div class="overall-progress-bar" id="overallProgressBar"></div>
            </div>
        </div>
        
        <!-- è§†é¢‘1åŒºåŸŸï¼ˆå·²æ›¿æ¢ä½ çš„SPOè§†é¢‘é“¾æ¥ï¼‰ -->
        <div id="video1" class="video-section">
            <div class="video-container">
                <video id="videoPlayer1" width="100%" height="100%" controls>
                    <source src="https://neusoftdbts.sharepoint.com/sites/vueL/Shared%20Documents/%E8%A7%86%E9%A2%91%E4%B8%80.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒHTML5è§†é¢‘æ’­æ”¾ï¼Œè¯·å‡çº§æµè§ˆå™¨ï¼
                </video>
                
                <!-- è§†é¢‘æ“ä½œæŒ‰é’® -->
                <div class="action-buttons" id="actionButtons1">
                    <button class="action-btn secondary" onclick="restartVideo(1)">é‡æ–°å­¦ä¹ </button>
                    <button class="action-btn" onclick="showQuestion(1)">å¼€å§‹ç­”é¢˜</button>
                </div>
                
                <!-- ç­”é¢˜å¼¹çª— -->
                <div class="question-modal hidden" id="question1">
                    <div class="question-content">
                        <div class="question-modal-header">
                            <div class="question-title">æµ‹è¯•é¢˜1ï¼šä»¥ä¸‹å“ªé¡¹ä¸æ˜¯é’“é±¼é‚®ä»¶çš„å¸¸è§ç‰¹å¾ï¼Ÿ</div>
                            <button class="close-question-btn" onclick="closeQuestion(1)">Ã—</button>
                        </div>
                        <div class="options">
                            <div class="option" onclick="selectAnswer(1, this)" data-answer="false">A. å‘ä»¶äººé‚®ç®±åœ°å€å¼‚å¸¸</div>
                            <div class="option" onclick="selectAnswer(1, this)" data-answer="false">B. åŒ…å«ç´§æ€¥å‚¬ä¿ƒçš„è¯­è¨€</div>
                            <div class="option" onclick="selectAnswer(1, this)" data-answer="true">C. é‚®ä»¶å†…å®¹ä½¿ç”¨å…¬å¸æ­£å¼æ¨¡æ¿</div>
                            <div class="option" onclick="selectAnswer(1, this)" data-answer="false">D. åŒ…å«ä¸æ˜æ¥æºçš„é™„ä»¶</div>
                        </div>
                        <div id="feedback1" style="margin-top: 15px;"></div>
                        <button class="btn hidden" id="continueBtn1" onclick="continueToVideo2()">ç»§ç»­å­¦ä¹ </button>
                        <button class="btn retry-btn hidden" id="retryBtn1" onclick="resetQuestion(1)">é‡æ–°ç­”é¢˜</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è§†é¢‘2åŒºåŸŸï¼ˆå·²æ›¿æ¢ä½ çš„SPOè§†é¢‘é“¾æ¥ï¼‰ -->
        <div id="video2" class="video-section hidden">
            <div class="video-container">
                <video id="videoPlayer2" width="100%" height="100%" controls>
                    <source src="https://neusoftdbts.sharepoint.com/sites/vueL/Shared%20Documents/%E8%A7%86%E9%A2%91%E4%BA%8C.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒHTML5è§†é¢‘æ’­æ”¾ï¼Œè¯·å‡çº§æµè§ˆå™¨ï¼
                </video>
                
                <div class="action-buttons" id="actionButtons2">
                    <button class="action-btn secondary" onclick="restartVideo(2)">é‡æ–°å­¦ä¹ </button>
                    <button class="action-btn" onclick="showQuestion(2)">å¼€å§‹ç­”é¢˜</button>
                </div>
                
                <div class="question-modal hidden" id="question2">
                    <div class="question-content">
                        <div class="question-modal-header">
                            <div class="question-title">æµ‹è¯•é¢˜2ï¼šæ”¶åˆ°ç–‘ä¼¼é’“é±¼é‚®ä»¶ï¼Œæ­£ç¡®çš„å¤„ç†æ–¹å¼æ˜¯ï¼Ÿ</div>
                            <button class="close-question-btn" onclick="closeQuestion(2)">Ã—</button>
                        </div>
                        <div class="options">
                            <div class="option" onclick="selectAnswer(2, this)" data-answer="false">A. ç‚¹å‡»é‚®ä»¶ä¸­çš„é“¾æ¥éªŒè¯çœŸä¼ª</div>
                            <div class="option" onclick="selectAnswer(2, this)" data-answer="false">B. å›å¤é‚®ä»¶è¯¢é—®å‘ä»¶äºº</div>
                            <div class="option" onclick="selectAnswer(2, this)" data-answer="true">C. ç«‹å³å‘ITéƒ¨é—¨æŠ¥å‘Šå¹¶åˆ é™¤é‚®ä»¶</div>
                            <div class="option" onclick="selectAnswer(2, this)" data-answer="false">D. è½¬å‘ç»™åŒäº‹ç¡®è®¤</div>
                        </div>
                        <div id="feedback2" style="margin-top: 15px;"></div>
                        <button class="btn hidden" id="continueBtn2" onclick="continueToVideo3()">ç»§ç»­å­¦ä¹ </button>
                        <button class="btn retry-btn hidden" id="retryBtn2" onclick="resetQuestion(2)">é‡æ–°ç­”é¢˜</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è§†é¢‘3åŒºåŸŸï¼ˆå·²æ›¿æ¢ä½ çš„SPOè§†é¢‘é“¾æ¥ï¼‰ -->
        <div id="video3" class="video-section hidden">
            <div class="video-container">
                <video id="videoPlayer3" width="100%" height="100%" controls>
                    <source src="https://neusoftdbts.sharepoint.com/sites/vueL/Shared%20Documents/%E8%A7%86%E9%A2%91%E4%B8%89.mp4" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒHTML5è§†é¢‘æ’­æ”¾ï¼Œè¯·å‡çº§æµè§ˆå™¨ï¼
                </video>
                
                <div class="action-buttons" id="actionButtons3">
                    <button class="action-btn secondary" onclick="restartVideo(3)">é‡æ–°å­¦ä¹ </button>
                    <button class="action-btn" onclick="showQuestion(3)">å¼€å§‹ç­”é¢˜</button>
                </div>
                
                <div class="question-modal hidden" id="question3">
                    <div class="question-content">
                        <div class="question-modal-header">
                            <div class="question-title">æµ‹è¯•é¢˜3ï¼šä¸æ…ç‚¹å‡»é’“é±¼é“¾æ¥åï¼Œé¦–å…ˆåº”è¯¥åšä»€ä¹ˆï¼Ÿ</div>
                            <button class="close-question-btn" onclick="closeQuestion(3)">Ã—</button>
                        </div>
                        <div class="options">
                            <div class="option" onclick="selectAnswer(3, this)" data-answer="true">A. æ–­å¼€ç½‘ç»œå¹¶å‘ITéƒ¨é—¨æŠ¥å‘Š</div>
                            <div class="option" onclick="selectAnswer(3, this)" data-answer="false">B. å…³é—­æµè§ˆå™¨ç»§ç»­å·¥ä½œ</div>
                            <div class="option" onclick="selectAnswer(3, this)" data-answer="false">C. å•ç‹¬è¿è¡Œæ€æ¯’è½¯ä»¶</div>
                            <div class="option" onclick="selectAnswer(3, this)" data-answer="false">D. é‡å¯ç”µè„‘</div>
                        </div>
                        <div id="feedback3" style="margin-top: 15px;"></div>
                        <button class="btn hidden" id="continueBtn3" onclick="showSurvey()">ç»§ç»­å­¦ä¹ </button>
                        <button class="btn retry-btn hidden" id="retryBtn3" onclick="resetQuestion(3)">é‡æ–°ç­”é¢˜</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ»¡æ„åº¦è°ƒæŸ¥é—®å· -->
        <div id="survey" class="survey-container hidden">
            <h2 class="survey-title">åŸ¹è®­æ»¡æ„åº¦è°ƒæŸ¥é—®å·</h2>
            
            <div class="rating-section">
                <label class="rating-label">1. è¯·ä¸ºæœ¬æ¬¡åŸ¹è®­æ‰“åˆ†ï¼ˆ1æ˜Ÿæœ€ä½ï¼Œ5æ˜Ÿæœ€é«˜ï¼‰ï¼š</label>
                <div class="stars">
                    <span class="star" data-rating="1" onclick="selectRating(1)">â˜…</span>
                    <span class="star" data-rating="2" onclick="selectRating(2)">â˜…</span>
                    <span class="star" data-rating="3" onclick="selectRating(3)">â˜…</span>
                    <span class="star" data-rating="4" onclick="selectRating(4)">â˜…</span>
                    <span class="star" data-rating="5" onclick="selectRating(5)">â˜…</span>
                </div>
            </div>
            
            <div class="comment-section">
                <label class="rating-label">2. æ‚¨å¯¹æœ¬æ¬¡åŸ¹è®­æœ‰ä»€ä¹ˆå»ºè®®æˆ–æ„è§ï¼Ÿï¼š</label>
                <textarea class="comment-input" id="surveyComment" placeholder="è¯·è¾“å…¥æ‚¨çš„å»ºè®®æˆ–æ„è§ï¼ˆé€‰å¡«ï¼‰"></textarea>
            </div>
            
            <button class="submit-survey-btn" id="submitSurveyBtn" disabled onclick="submitSurvey()">æäº¤é—®å·</button>
        </div>
    </div>

    <script>
        // ========== æ ¸å¿ƒé…ç½®é¡¹ï¼ˆç¡®è®¤å’Œä½ çš„SPOç¯å¢ƒä¸€è‡´ï¼‰ ==========
        const LIST_TITLE = "é’“é±¼é‚®ä»¶åŸ¹è®­è¿›åº¦"; // ä½ çš„SPO Liståç§°
        const SITE_URL = "https://neusoftdbts.sharepoint.com/sites/vueL"; // ä½ çš„SPOç«™ç‚¹URL
        
        // å…¨å±€å˜é‡
        let currentUser = { upn: "", displayName: "" }; // M365ç”¨æˆ·ä¿¡æ¯
        let selectedRating = 0; // æ»¡æ„åº¦è¯„åˆ†
        let progress = {
            currentStep: 1,
            video1: { watched: false, progress: 0, duration: 0, playing: false },
            video2: { watched: false, progress: 0, duration: 0, playing: false },
            video3: { watched: false, progress: 0, duration: 0, playing: false },
            q1Correct: false,
            q2Correct: false,
            q3Correct: false,
            surveyDone: false,
            satisfaction: 0,
            satisfactionTxt: "",
            isAllCompleted: false
        };

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log("ğŸ” å¼€å§‹åˆå§‹åŒ–é¡µé¢...");
                // 1. è·å–M365ç”¨æˆ·èº«ä»½ï¼ˆSPOè‡ªåŠ¨è®¤è¯ï¼‰
                await getCurrentUserInfo();
                console.log(`âœ… è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸï¼š${currentUser.upn}`);
                // 2. ä»SPO ListåŠ è½½ç”¨æˆ·è¿›åº¦
                await loadProgressFromSPO();
                console.log("âœ… åŠ è½½å†å²è¿›åº¦æˆåŠŸ");
                // 3. åˆå§‹åŒ–æ»¡æ„åº¦é—®å·çŠ¶æ€
                initSurveyState();
                // 4. åˆå§‹åŒ–è§†é¢‘å’ŒUI
                progress.isAllCompleted = progress.video3.watched && progress.q3Correct;
                initVideoWithMetadata(1);
                initVideoWithMetadata(2);
                initVideoWithMetadata(3);
                updateStepButtons();
                updateAllProgressDisplays();
                alert("âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆï¼");
            } catch (err) {
                console.error("âŒ åˆå§‹åŒ–å¤±è´¥ï¼š", err);
                alert(`âŒ åˆå§‹åŒ–å‡ºé”™ï¼Œè¯·ç¡®è®¤å·²ç™»å½•M365è´¦å·å¹¶åˆ·æ–°é¡µé¢ï¼\né”™è¯¯ä¿¡æ¯ï¼š${err}`);
            }
        });

        // ========== SPOèº«ä»½ä¸æ•°æ®æ“ä½œæ ¸å¿ƒæ–¹æ³• ==========
        /**
         * è·å–å½“å‰ç™»å½•çš„M365ç”¨æˆ·ä¿¡æ¯ï¼ˆUPNå’Œæ˜¾ç¤ºåï¼‰
         */
        function getCurrentUserInfo() {
            return new Promise((resolve, reject) => {
                console.log("ğŸ” å¼€å§‹è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯...");
                const context = new SP.ClientContext(SITE_URL);
                const web = context.get_web();
                const user = web.get_currentUser();
                context.load(user);
                context.executeQueryAsync(
                    () => {
                        // æ¸…ç†UPNæ ¼å¼ï¼ˆå»æ‰i:0#.f|membership|å‰ç¼€ï¼‰
                        currentUser.upn = user.get_loginName().replace("i:0#.f|membership|", "");
                        currentUser.displayName = user.get_title();
                        console.log(`âœ… ç”¨æˆ·ä¿¡æ¯ï¼šUPN=${currentUser.upn}ï¼Œå§“å=${currentUser.displayName}`);
                        resolve();
                    },
                    (sender, args) => {
                        const errMsg = `è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š${args.get_message()}`;
                        console.error("âŒ", errMsg);
                        alert(`âŒ ${errMsg}\nè¯·æ£€æŸ¥æ˜¯å¦æœ‰SPOè®¿é—®æƒé™ï¼`);
                        reject(errMsg);
                    }
                );
            });
        }

        /**
         * ä»SPO ListåŠ è½½ç”¨æˆ·å­¦ä¹ è¿›åº¦
         */
        function loadProgressFromSPO() {
            return new Promise((resolve, reject) => {
                console.log(`ğŸ” å¼€å§‹ä»Listã€${LIST_TITLE}ã€‘åŠ è½½è¿›åº¦...`);
                const context = new SP.ClientContext(SITE_URL);
                const list = context.get_web().get_lists().getByTitle(LIST_TITLE);
                
                // CAMLæŸ¥è¯¢ï¼šæŒ‰UPNç­›é€‰å½“å‰ç”¨æˆ·è®°å½•
                const camlQuery = new SP.CamlQuery();
                camlQuery.set_viewXml(`
                    <View>
                        <Query>
                            <Where>
                                <Eq>
                                    <FieldRef Name='Title' />
                                    <Value Type='Text'>${currentUser.upn}</Value>
                                </Eq>
                            </Where>
                        </Query>
                        <RowLimit>1</RowLimit>
                    </View>
                `);

                const items = list.getItems(camlQuery);
                context.load(items);
                context.executeQueryAsync(
                    () => {
                        if (items.get_count() > 0) {
                            // æœ‰å†å²è®°å½•ï¼šè§£ææ•°æ®
                            const item = items.itemAt(0);
                            progress = {
                                currentStep: item.get_item('CurrentStep') || 1,
                                video1: {
                                    watched: item.get_item('Video1Watched') || false,
                                    progress: item.get_item('Video1Progress') || 0,
                                    duration: 0,
                                    playing: false
                                },
                                video2: {
                                    watched: item.get_item('Video2Watched') || false,
                                    progress: item.get_item('Video2Progress') || 0,
                                    duration: 0,
                                    playing: false
                                },
                                video3: {
                                    watched: item.get_item('Video3Watched') || false,
                                    progress: item.get_item('Video3Progress') || 0,
                                    duration: 0,
                                    playing: false
                                },
                                q1Correct: item.get_item('Q1Correct') || false,
                                q2Correct: item.get_item('Q2Correct') || false,
                                q3Correct: item.get_item('Q3Correct') || false,
                                surveyDone: item.get_item('SurveyDone') || false,
                                satisfaction: item.get_item('Satisfaction') || 0,
                                satisfactionTxt: item.get_item('SatisfactionTxt') || "",
                                isAllCompleted: false
                            };
                            console.log("âœ… åŠ è½½åˆ°å†å²è¿›åº¦ï¼š", progress);
                            alert(`âœ… åŠ è½½å†å²è¿›åº¦æˆåŠŸï¼å½“å‰æ­¥éª¤ï¼š${progress.currentStep}`);
                        } else {
                            // æ— å†å²è®°å½•ï¼šåˆå§‹åŒ–é»˜è®¤å€¼å¹¶åˆ›å»ºæ–°è®°å½•
                            progress = {
                                currentStep: 1,
                                video1: { watched: false, progress: 0, duration: 0, playing: false },
                                video2: { watched: false, progress: 0, duration: 0, playing: false },
                                video3: { watched: false, progress: 0, duration: 0, playing: false },
                                q1Correct: false,
                                q2Correct: false,
                                q3Correct: false,
                                surveyDone: false,
                                satisfaction: 0,
                                satisfactionTxt: "",
                                isAllCompleted: false
                            };
                            console.log("â„¹ï¸ æ— å†å²è¿›åº¦ï¼Œåˆå§‹åŒ–é»˜è®¤å€¼å¹¶åˆ›å»ºæ–°è®°å½•");
                            alert("â„¹ï¸ é¦–æ¬¡è®¿é—®ï¼Œæ­£åœ¨åˆ›å»ºæ–°çš„å­¦ä¹ è®°å½•...");
                            saveProgressToSPO(); // é¦–æ¬¡è®¿é—®åˆ›å»ºè®°å½•
                        }
                        resolve();
                    },
                    (sender, args) => {
                        const errMsg = `åŠ è½½è¿›åº¦å¤±è´¥ï¼š${args.get_message()}`;
                        console.error("âŒ", errMsg);
                        alert(`âŒ ${errMsg}\nè¯·æ£€æŸ¥Liståç§°æ˜¯å¦æ­£ç¡®ï¼`);
                        reject(errMsg);
                    }
                );
            });
        }

        /**
         * ä¿å­˜è¿›åº¦åˆ°SPO Listï¼ˆæ·»åŠ è°ƒè¯•æç¤ºï¼‰
         */
        function saveProgressToSPO() {
            return new Promise((resolve, reject) => {
                console.log(`ğŸ” å¼€å§‹ä¿å­˜è¿›åº¦åˆ°Listã€${LIST_TITLE}ã€‘...`);
                console.log("ğŸ“ å¾…ä¿å­˜çš„è¿›åº¦æ•°æ®ï¼š", progress);
                const context = new SP.ClientContext(SITE_URL);
                const list = context.get_web().get_lists().getByTitle(LIST_TITLE);
                
                // å…ˆæŸ¥è¯¢æ˜¯å¦å­˜åœ¨å½“å‰ç”¨æˆ·è®°å½•
                const camlQuery = new SP.CamlQuery();
                camlQuery.set_viewXml(`
                    <View>
                        <Query>
                            <Where>
                                <Eq>
                                    <FieldRef Name='Title' />
                                    <Value Type='Text'>${currentUser.upn}</Value>
                                </Eq>
                            </Where>
                        </Query>
                        <RowLimit>1</RowLimit>
                    </View>
                `);

                const items = list.getItems(camlQuery);
                context.load(items);
                context.executeQueryAsync(
                    () => {
                        let listItem;
                        if (items.get_count() > 0) {
                            // æ›´æ–°å·²æœ‰è®°å½•
                            listItem = items.itemAt(0);
                            console.log("â„¹ï¸ æ‰¾åˆ°ç”¨æˆ·è®°å½•ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œ");
                        } else {
                            // åˆ›å»ºæ–°è®°å½•
                            const itemCreateInfo = new SP.ListItemCreationInformation();
                            listItem = list.addItem(itemCreateInfo);
                            listItem.set_item('Title', currentUser.upn); // UPNä½œä¸ºä¸»é”®
                            listItem.set_item('DisplayName', currentUser.displayName);
                            console.log("â„¹ï¸ æœªæ‰¾åˆ°ç”¨æˆ·è®°å½•ï¼Œæ‰§è¡Œåˆ›å»ºæ“ä½œ");
                        }

                        // å¡«å……æ‰€æœ‰è¿›åº¦æ•°æ®
                        listItem.set_item('CurrentStep', progress.currentStep);
                        listItem.set_item('Video1Watched', progress.video1.watched);
                        listItem.set_item('Video1Progress', Math.round(progress.video1.progress));
                        listItem.set_item('Q1Correct', progress.q1Correct);
                        listItem.set_item('Video2Watched', progress.video2.watched);
                        listItem.set_item('Video2Progress', Math.round(progress.video2.progress));
                        listItem.set_item('Q2Correct', progress.q2Correct);
                        listItem.set_item('Video3Watched', progress.video3.watched);
                        listItem.set_item('Video3Progress', Math.round(progress.video3.progress));
                        listItem.set_item('Q3Correct', progress.q3Correct);
                        listItem.set_item('SurveyDone', progress.surveyDone);
                        listItem.set_item('Satisfaction', progress.satisfaction);
                        listItem.set_item('SatisfactionTxt', progress.satisfactionTxt);
                        listItem.set_item('LastUpdate', new Date());

                        // æäº¤ä¿å­˜
                        listItem.update();
                        context.load(listItem);
                        context.executeQueryAsync(
                            () => {
                                console.log("âœ… è¿›åº¦ä¿å­˜åˆ°ListæˆåŠŸï¼");
                                alert("âœ… è¿›åº¦å·²æˆåŠŸè®°å½•åˆ°SharePoint Listï¼");
                                resolve();
                            },
                            (sender, args) => {
                                const errMsg = `ä¿å­˜è¿›åº¦å¤±è´¥ï¼š${args.get_message()}`;
                                console.error("âŒ", errMsg);
                                alert(`âŒ ${errMsg}\nè¯·æ£€æŸ¥Listå­—æ®µæ˜¯å¦åŒ¹é…/æƒé™æ˜¯å¦è¶³å¤Ÿï¼`);
                                reject(errMsg);
                            }
                        );
                    },
                    (sender, args) => {
                        const errMsg = `æŸ¥è¯¢ç”¨æˆ·è®°å½•å¤±è´¥ï¼š${args.get_message()}`;
                        console.error("âŒ", errMsg);
                        alert(`âŒ ${errMsg}`);
                        reject(errMsg);
                    }
                );
            });
        }

        /**
         * ç®€åŒ–çš„ä¿å­˜æ–¹æ³•ï¼ˆå¼‚æ­¥ä¸é˜»å¡UIï¼‰
         */
        function saveProgress() {
            console.log("ğŸ” è§¦å‘è¿›åº¦ä¿å­˜...");
            saveProgressToSPO().catch(err => console.error("âŒ è¿›åº¦ä¿å­˜å¤±è´¥ï¼š", err));
        }

        /**
         * é‡ç½®ç”¨æˆ·æ‰€æœ‰å­¦ä¹ è¿›åº¦
         */
        function resetProgress() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            const context = new SP.ClientContext(SITE_URL);
            const list = context.get_web().get_lists().getByTitle(LIST_TITLE);
            
            // æŸ¥è¯¢å½“å‰ç”¨æˆ·è®°å½•
            const camlQuery = new SP.CamlQuery();
            camlQuery.set_viewXml(`
                <View>
                    <Query>
                        <Where>
                            <Eq>
                                <FieldRef Name='Title' />
                                <Value Type='Text'>${currentUser.upn}</Value>
                            </Eq>
                        </Where>
                    </Query>
                </View>
            `);

            const items = list.getItems(camlQuery);
            context.load(items);
            context.executeQueryAsync(
                () => {
                    if (items.get_count() > 0) {
                        // åˆ é™¤ç”¨æˆ·è®°å½•
                        const item = items.itemAt(0);
                        item.deleteObject();
                        context.executeQueryAsync(
                            () => {
                                alert("âœ… è¿›åº¦é‡ç½®æˆåŠŸï¼");
                                location.reload();
                            },
                            (sender, args) => alert(`âŒ é‡ç½®å¤±è´¥ï¼š${args.get_message()}`)
                        );
                    } else {
                        alert("â„¹ï¸ æš‚æ— å­¦ä¹ è¿›åº¦å¯é‡ç½®ï¼");
                        location.reload();
                    }
                },
                (sender, args) => alert(`âŒ æŸ¥è¯¢è¿›åº¦å¤±è´¥ï¼š${args.get_message()}`)
            );
        }

        // ========== è§†é¢‘ä¸ç­”é¢˜æ ¸å¿ƒé€»è¾‘ ==========
        /**
         * åˆå§‹åŒ–è§†é¢‘å…ƒæ•°æ®ï¼ˆæ—¶é•¿ã€è¿›åº¦ï¼‰
         * @param {number} num è§†é¢‘ç¼–å·ï¼ˆ1/2/3ï¼‰
         */
        function initVideoWithMetadata(num) {
            const video = document.getElementById(`videoPlayer${num}`);
            const actionBtn = document.getElementById(`actionButtons${num}`);
            
            // æ¢å¤ä¸Šæ¬¡æ’­æ”¾è¿›åº¦
            if (progress[`video${num}`].progress > 0) {
                video.currentTime = progress[`video${num}`].progress;
                console.log(`â„¹ï¸ æ¢å¤è§†é¢‘${num}è¿›åº¦ï¼š${progress[`video${num}`].progress}ç§’`);
            }

            // ç›‘å¬è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ
            video.addEventListener('loadedmetadata', () => {
                progress[`video${num}`].duration = video.duration;
                console.log(`âœ… è§†é¢‘${num}å…ƒæ•°æ®åŠ è½½å®Œæˆï¼Œæ—¶é•¿ï¼š${video.duration}ç§’`);
                saveProgress();
                updateStepProgress(num);
            });

            // ç›‘å¬è§†é¢‘æ’­æ”¾çŠ¶æ€
            video.addEventListener('play', () => {
                progress[`video${num}`].playing = true;
                actionBtn.classList.remove('show');
                console.log(`â„¹ï¸ è§†é¢‘${num}å¼€å§‹æ’­æ”¾`);
            });

            // ç›‘å¬è§†é¢‘æš‚åœ
            video.addEventListener('pause', () => {
                progress[`video${num}`].playing = false;
                // è¿›åº¦â‰¥98%æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                if (video.currentTime / progress[`video${num}`].duration >= 0.98 || video.ended) {
                    actionBtn.classList.add('show');
                    progress[`video${num}`].watched = true;
                    console.log(`âœ… è§†é¢‘${num}æ’­æ”¾å®Œæˆï¼ˆè¿›åº¦â‰¥98%ï¼‰`);
                    alert(`âœ… è§†é¢‘${num}å·²çœ‹å®Œï¼æ­£åœ¨ä¿å­˜è¿›åº¦åˆ°List...`);
                }
                // ä¿å­˜æš‚åœæ—¶çš„è¿›åº¦
                progress[`video${num}`].progress = video.currentTime;
                saveProgress();
                updateStepProgress(num);
                console.log(`â„¹ï¸ è§†é¢‘${num}æš‚åœï¼Œå½“å‰è¿›åº¦ï¼š${video.currentTime}ç§’`);
            });

            // ç›‘å¬è§†é¢‘æ’­æ”¾è¿›åº¦ï¼ˆå®æ—¶ä¿å­˜ï¼‰
            video.addEventListener('timeupdate', () => {
                if (progress[`video${num}`].duration === 0) return;
                
                // å®Œæˆå…¨éƒ¨å­¦ä¹ åå¼ºåˆ¶è¿›åº¦100%
                if (progress.isAllCompleted) {
                    progress[`video${num}`].progress = progress[`video${num}`].duration;
                    progress[`video${num}`].watched = true;
                } else {
                    progress[`video${num}`].progress = video.currentTime;
                }
                
                // æ¯2ç§’ä¿å­˜ä¸€æ¬¡ï¼ˆé¿å…é«˜é¢‘è¯·æ±‚ï¼‰
                if (!progress[`video${num}`]._saveTimer) {
                    progress[`video${num}`]._saveTimer = setTimeout(() => {
                        saveProgress();
                        progress[`video${num}`]._saveTimer = null;
                    }, 2000);
                }
                updateStepProgress(num);
            });

            // ç›‘å¬è§†é¢‘æ’­æ”¾ç»“æŸ
            video.addEventListener('ended', () => {
                progress[`video${num}`].playing = false;
                progress[`video${num}`].watched = true;
                progress[`video${num}`].progress = progress[`video${num}`].duration;
                saveProgress();
                actionBtn.classList.add('show');
                console.log(`âœ… è§†é¢‘${num}æ’­æ”¾ç»“æŸ`);
                alert(`âœ… è§†é¢‘${num}æ’­æ”¾å®Œæˆï¼å·²è‡ªåŠ¨ä¿å­˜è¿›åº¦åˆ°List`);
                
                // æ›´æ–°å®ŒæˆçŠ¶æ€å’ŒUI
                progress.isAllCompleted = progress.video3.watched && progress.q3Correct;
                updateStepButtons();
                updateOverallProgress();
            });
        }

        /**
         * æ˜¾ç¤ºç­”é¢˜å¼¹çª—
         * @param {number} num é¢˜ç›®ç¼–å·ï¼ˆ1/2/3ï¼‰
         */
        function showQuestion(num) {
            console.log(`â„¹ï¸ æ˜¾ç¤º${num}å·é¢˜ç›®å¼¹çª—`);
            document.getElementById(`question${num}`).classList.remove('hidden');
        }

        /**
         * å…³é—­ç­”é¢˜å¼¹çª—
         * @param {number} num é¢˜ç›®ç¼–å·ï¼ˆ1/2/3ï¼‰
         */
        function closeQuestion(num) {
            console.log(`â„¹ï¸ å…³é—­${num}å·é¢˜ç›®å¼¹çª—`);
            document.getElementById(`question${num}`).classList.add('hidden');
        }

        /**
         * é€‰æ‹©ç­”é¢˜é€‰é¡¹
         * @param {number} num é¢˜ç›®ç¼–å·ï¼ˆ1/2/3ï¼‰
         * @param {HTMLElement} el é€‰é¡¹å…ƒç´ 
         */
        function selectAnswer(num, el) {
            const isCorrect = el.dataset.answer === "true";
            const options = document.querySelectorAll(`#question${num} .option`);
            const feedback = document.getElementById(`feedback${num}`);
            const continueBtn = document.getElementById(`continueBtn${num}`);
            const retryBtn = document.getElementById(`retryBtn${num}`);

            // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
            options.forEach(opt => opt.style.pointerEvents = 'none');

            // æ ‡è®°æ­£ç¡®/é”™è¯¯é€‰é¡¹
            options.forEach(opt => {
                if (opt.dataset.answer === "true") {
                    opt.classList.add('correct');
                } else if (opt === el && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });

            // æ˜¾ç¤ºåé¦ˆä¿¡æ¯
            if (isCorrect) {
                feedback.textContent = "å›ç­”æ­£ç¡®ï¼";
                feedback.style.color = "#27ae60";
                progress[`q${num}Correct`] = true;
                continueBtn.classList.remove('hidden'); // æ˜¾ç¤ºç»§ç»­æŒ‰é’®
                console.log(`âœ… ${num}å·é¢˜ç›®å›ç­”æ­£ç¡®`);
                alert(`âœ… ${num}å·é¢˜ç›®å›ç­”æ­£ç¡®ï¼æ­£åœ¨ä¿å­˜ç­”é¢˜ç»“æœåˆ°List...`);
            } else {
                feedback.textContent = "å›ç­”é”™è¯¯ï¼Œè¯·é‡æ–°ç­”é¢˜ï¼";
                feedback.style.color = "#e74c3c";
                progress[`q${num}Correct`] = false;
                retryBtn.classList.remove('hidden'); // æ˜¾ç¤ºé‡è¯•æŒ‰é’®
                console.log(`âŒ ${num}å·é¢˜ç›®å›ç­”é”™è¯¯`);
                alert(`âŒ ${num}å·é¢˜ç›®å›ç­”é”™è¯¯ï¼Œè¯·é‡æ–°ç­”é¢˜ï¼`);
            }

            // ä¿å­˜ç­”é¢˜ç»“æœ
            saveProgress();
            updateOverallProgress();
        }

        /**
         * é‡æ–°ç­”é¢˜
         * @param {number} num é¢˜ç›®ç¼–å·ï¼ˆ1/2/3ï¼‰
         */
        function resetQuestion(num) {
            const options = document.querySelectorAll(`#question${num} .option`);
            const feedback = document.getElementById(`feedback${num}`);
            const continueBtn = document.getElementById(`continueBtn${num}`);
            const retryBtn = document.getElementById(`retryBtn${num}`);

            // é‡ç½®é€‰é¡¹æ ·å¼å’ŒçŠ¶æ€
            options.forEach(opt => {
                opt.classList.remove('correct', 'incorrect');
                opt.style.pointerEvents = 'auto';
            });

            // éšè—åé¦ˆå’ŒæŒ‰é’®
            feedback.textContent = "";
            continueBtn.classList.add('hidden');
            retryBtn.classList.add('hidden');
            console.log(`â„¹ï¸ é‡ç½®${num}å·é¢˜ç›®`);
        }

        /**
         * åˆ‡æ¢åˆ°è§†é¢‘2
         */
        function continueToVideo2() {
            closeQuestion(1);
            handleStepClick(2);
        }

        /**
         * åˆ‡æ¢åˆ°è§†é¢‘3
         */
        function continueToVideo3() {
            closeQuestion(2);
            handleStepClick(3);
        }

        /**
         * æ˜¾ç¤ºæ»¡æ„åº¦é—®å·
         */
        function showSurvey() {
            closeQuestion(3);
            handleStepClick(4);
        }

        /**
         * é‡æ–°æ’­æ”¾è§†é¢‘
         * @param {number} num è§†é¢‘ç¼–å·ï¼ˆ1/2/3ï¼‰
         */
        function restartVideo(num) {
            const video = document.getElementById(`videoPlayer${num}`);
            video.currentTime = 0;
            video.play();
            progress[`video${num}`].progress = 0;
            progress[`video${num}`].watched = false;
            saveProgress();
            updateStepProgress(num);
            console.log(`â„¹ï¸ é‡æ–°æ’­æ”¾è§†é¢‘${num}`);
            alert(`â„¹ï¸ è§†é¢‘${num}å·²é‡ç½®ï¼Œæ­£åœ¨é‡æ–°å­¦ä¹ ...`);
        }

        /**
         * åˆ‡æ¢æ­¥éª¤ï¼ˆè§†é¢‘/é—®å·ï¼‰
         * @param {number} step æ­¥éª¤ç¼–å·ï¼ˆ1/2/3/4ï¼‰
         */
        function handleStepClick(step) {
            // éªŒè¯æ­¥éª¤è®¿é—®æƒé™ï¼ˆæœªå®Œæˆå‰åºæ­¥éª¤ä¸èƒ½è·³è½¬åˆ°åç»­ï¼‰
            if (step > 1 && !progress[`video${step-1}`].watched && !progress[`q${step-1}Correct`]) {
                alert(`âŒ è¯·å…ˆå®Œæˆ${step-1}å·è§†é¢‘çš„å­¦ä¹ å’Œç­”é¢˜ï¼`);
                return;
            }

            // éšè—æ‰€æœ‰æ­¥éª¤å†…å®¹
            document.getElementById('video1').classList.add('hidden');
            document.getElementById('video2').classList.add('hidden');
            document.getElementById('video3').classList.add('hidden');
            document.getElementById('survey').classList.add('hidden');

            // é‡ç½®æ‰€æœ‰æ­¥éª¤æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active', 'completed');
            });

            // æ ‡è®°å·²å®Œæˆçš„æ­¥éª¤
            for (let i = 1; i < step; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
            }

            // æ¿€æ´»å½“å‰æ­¥éª¤
            document.getElementById(`step${step}`).classList.add('active');
            progress.currentStep = step;

            // æ˜¾ç¤ºå½“å‰æ­¥éª¤å†…å®¹
            if (step === 1) document.getElementById('video1').classList.remove('hidden');
            else if (step === 2) document.getElementById('video2').classList.remove('hidden');
            else if (step === 3) document.getElementById('video3').classList.remove('hidden');
            else if (step === 4) document.getElementById('survey').classList.remove('hidden');

            // ä¿å­˜å½“å‰æ­¥éª¤
            saveProgress();
            updateOverallProgress();
            console.log(`â„¹ï¸ åˆ‡æ¢åˆ°${step}å·æ­¥éª¤`);
            alert(`â„¹ï¸ å·²åˆ‡æ¢åˆ°${step}å·æ­¥éª¤ï¼Œè¿›åº¦å·²ä¿å­˜ï¼`);
        }

        /**
         * æ›´æ–°å•ä¸ªæ­¥éª¤çš„è¿›åº¦æ˜¾ç¤º
         * @param {number} num æ­¥éª¤ç¼–å·ï¼ˆ1/2/3/4ï¼‰
         */
        function updateStepProgress(num) {
            if (num === 4) {
                // é—®å·è¿›åº¦ï¼šå·²æäº¤100%ï¼Œå¦åˆ™0%
                const progressPercent = progress.surveyDone ? 100 : 0;
                document.getElementById(`step4Progress`).textContent = `${progressPercent}%`;
            } else {
                // è§†é¢‘è¿›åº¦ï¼šè®¡ç®—ç™¾åˆ†æ¯”
                const progressPercent = progress[`video${num}`].duration > 0 
                    ? Math.round((progress[`video${num}`].progress / progress[`video${num}`].duration) * 100) 
                    : 0;
                document.getElementById(`step${num}Progress`).textContent = `${progressPercent}%`;
            }
        }

        /**
         * æ›´æ–°æ‰€æœ‰æ­¥éª¤çš„è¿›åº¦æ˜¾ç¤º
         */
        function updateAllProgressDisplays() {
            updateStepProgress(1);
            updateStepProgress(2);
            updateStepProgress(3);
            updateStepProgress(4);
            updateOverallProgress();
        }

        /**
         * æ›´æ–°æ•´ä½“è¿›åº¦æ¡
         */
        function updateOverallProgress() {
            // è®¡ç®—æ€»è¿›åº¦ï¼ˆè§†é¢‘1+è§†é¢‘2+è§†é¢‘3+é—®å·ï¼Œæ¯é¡¹25%ï¼‰
            let totalProgress = 0;
            
            // è§†é¢‘1è¿›åº¦ï¼ˆ25%æƒé‡ï¼‰
            totalProgress += progress.video1.watched && progress.q1Correct 
                ? 25 
                : (progress.video1.duration > 0 ? (progress.video1.progress / progress.video1.duration) * 25 : 0);
            
            // è§†é¢‘2è¿›åº¦ï¼ˆ25%æƒé‡ï¼‰
            totalProgress += progress.video2.watched && progress.q2Correct 
                ? 25 
                : (progress.video2.duration > 0 ? (progress.video2.progress / progress.video2.duration) * 25 : 0);
            
            // è§†é¢‘3è¿›åº¦ï¼ˆ25%æƒé‡ï¼‰
            totalProgress += progress.video3.watched && progress.q3Correct 
                ? 25 
                : (progress.video3.duration > 0 ? (progress.video3.progress / progress.video3.duration) * 25 : 0);
            
            // é—®å·è¿›åº¦ï¼ˆ25%æƒé‡ï¼‰
            totalProgress += progress.surveyDone ? 25 : 0;

            // æ›´æ–°è¿›åº¦æ¡æ ·å¼
            const progressBar = document.getElementById('overallProgressBar');
            progressBar.style.width = `${Math.round(totalProgress)}%`;
            console.log(`â„¹ï¸ æ•´ä½“è¿›åº¦æ›´æ–°ä¸ºï¼š${Math.round(totalProgress)}%`);
        }

        // ========== æ»¡æ„åº¦é—®å·æ ¸å¿ƒé€»è¾‘ ==========
        /**
         * åˆå§‹åŒ–é—®å·çŠ¶æ€ï¼ˆæ¢å¤å†å²è¯„åˆ†/æ„è§ï¼‰
         */
        function initSurveyState() {
            if (progress.satisfaction > 0) {
                selectedRating = progress.satisfaction;
                // æ¢å¤æ˜Ÿæ˜Ÿé€‰ä¸­çŠ¶æ€
                const stars = document.querySelectorAll('.star');
                stars.forEach(star => {
                    const starRating = parseInt(star.dataset.rating);
                    if (starRating <= progress.satisfaction) {
                        star.classList.add('active');
                    }
                });
                // æ¢å¤æ„è§æ–‡æœ¬
                document.getElementById("surveyComment").value = progress.satisfactionTxt || "";
                console.log(`â„¹ï¸ æ¢å¤é—®å·è¯„åˆ†ï¼š${progress.satisfaction}æ˜Ÿ`);
            }

            // å·²æäº¤é—®å·ï¼šç¦ç”¨ç¼–è¾‘
            if (progress.surveyDone) {
                document.getElementById("submitSurveyBtn").disabled = true;
                document.getElementById("submitSurveyBtn").textContent = "å·²æäº¤";
                document.querySelectorAll('.star').forEach(star => star.style.pointerEvents = 'none');
                document.getElementById("surveyComment").disabled = true;
                console.log(`â„¹ï¸ é—®å·å·²æäº¤ï¼Œç¦ç”¨ç¼–è¾‘`);
            }
        }

        /**
         * é€‰æ‹©æ»¡æ„åº¦è¯„åˆ†
         * @param {number} rating è¯„åˆ†ï¼ˆ1-5ï¼‰
         * @param {boolean} isInit æ˜¯å¦åˆå§‹åŒ–è°ƒç”¨
         */
        function selectRating(rating, isInit = false) {
            if (progress.surveyDone) return; // å·²æäº¤åˆ™ç¦æ­¢ä¿®æ”¹
            
            selectedRating = rating;
            progress.satisfaction = rating;
            
            // æ›´æ–°æ˜Ÿæ˜Ÿæ ·å¼
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                const starRating = parseInt(star.dataset.rating);
                star.classList.toggle('active', starRating <= rating);
            });

            // å¯ç”¨æäº¤æŒ‰é’®
            document.getElementById("submitSurveyBtn").disabled = !isInit && rating === 0;
            
            // å®æ—¶ä¿å­˜è¯„åˆ†
            saveProgress();
            console.log(`â„¹ï¸ é€‰æ‹©é—®å·è¯„åˆ†ï¼š${rating}æ˜Ÿ`);
            alert(`â„¹ï¸ å·²é€‰æ‹©${rating}æ˜Ÿè¯„åˆ†ï¼Œè¿›åº¦å·²ä¿å­˜ï¼`);
        }

        /**
         * æäº¤æ»¡æ„åº¦é—®å·
         */
        function submitSurvey() {
            if (selectedRating === 0) {
                alert("âŒ è¯·å…ˆä¸ºæœ¬æ¬¡åŸ¹è®­æ‰“åˆ†ï¼");
                return;
            }

            // è·å–æ„è§æ–‡æœ¬
            const comment = document.getElementById("surveyComment").value.trim();
            progress.surveyDone = true;
            progress.satisfaction = selectedRating;
            progress.satisfactionTxt = comment;

            console.log(`ğŸ” æäº¤é—®å·ï¼š${selectedRating}æ˜Ÿï¼Œæ„è§ï¼š${comment}`);
            alert("ğŸ” æ­£åœ¨æäº¤é—®å·åˆ°SharePoint List...");
            
            // ä¿å­˜åˆ°SPOå¹¶åé¦ˆ
            saveProgressToSPO()
                .then(() => {
                    alert('âœ… é—®å·æäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å®è´µåé¦ˆ');
                    // ç¦ç”¨é—®å·ç¼–è¾‘
                    document.getElementById("submitSurveyBtn").disabled = true;
                    document.getElementById("submitSurveyBtn").textContent = "å·²æäº¤";
                    document.querySelectorAll('.star').forEach(star => star.style.pointerEvents = 'none');
                    document.getElementById("surveyComment").disabled = true;
                    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                    updateStepProgress(4);
                    updateOverallProgress();
                })
                .catch(err => {
                    alert(`âŒ æäº¤å¤±è´¥ï¼š${err}\nè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼`);
                });
        }
    </script>
</body>
</html>
