<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>钓鱼邮件培训-带调试写库</title>
    <style>
        body{font-family:Microsoft YaHei;background:#f5f7fa;padding:20px}
        .box{max-width:700px;margin:auto;background:#fff;padding:30px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        h1{text-align:center;color:#2c3e50;margin-bottom:20px}
        video{width:100%;border-radius:8px}
        .btn{padding:10px 20px;margin:10px 5px 0 0;border:none;border-radius:4px;color:#fff;background:#3498db;cursor:pointer}
        .btn:hover{background:#217dbb}
        .debug{color:#e74c3c;font-size:14px;margin-top:10px}
    </style>
    <!-- 1. 核心配置 -->
    <script>
        const CFG = {
            siteUrl: "https://neusoftdbts.sharepoint.com/sites/vueL",   // ← 你的站点
            listName: "钓鱼邮件培训进度",                                // ← 你的 List
            videoUrl:"https://neusoftdbts.sharepoint.com/sites/vueL/Shared%20Documents/%E8%A7%86%E9%A2%91%E4%B8%80.mp4"
        };
    </script>

    <!-- 2. 加载 SharePoint JSOM -->
    <script src="/_layouts/15/SP.Runtime.js"></script>
    <script src="/_layouts/15/SP.js"></script>
</head>
<body>
    <div class="box">
        <h1>钓鱼邮件安全培训</h1>

        <!-- 视频 -->
        <video id="v" controls>
            <source src="" type="video/mp4">
        </video>

        <!-- 按钮 -->
        <div>
            <button class="btn" onclick="playVideo()">播放</button>
            <button class="btn" onclick="markWatched()">标记已看完（写库）</button>
            <button class="btn" onclick="resetRec()">重置记录</button>
        </div>

        <!-- 调试信息 -->
        <div id="debug" class="debug">等待操作…</div>
    </div>

    <!-- 3. 业务+调试逻辑 -->
    <script>
        let email = "", itemId = 0;   // 当前用户 & List 项 ID

        /* 页面初始化 */
        window.onload = async () => {
            document.getElementById("v").src = CFG.videoUrl;
            await getUser();
            await loadOrCreateRec();
        };

        /* 拿登录邮箱 */
        async function getUser(){
            const ctx = new SP.ClientContext(CFG.siteUrl);
            const user = ctx.get_web().get_currentUser();
            ctx.load(user);
            await new Promise((res,rej)=>ctx.executeQueryAsync(res,()=>rej("getUser失败")));
            email = user.get_email() || user.get_loginName().split("|").pop();
            log(`当前用户：${email}`);
        }

        /* 读记录 / 没有就新建 */
        async function loadOrCreateRec(){
            const ctx = new SP.ClientContext(CFG.siteUrl);
            const list = ctx.get_web().get_lists().getByTitle(CFG.listName);
            const q = new SP.CamlQuery();
            q.set_viewXml(`<View><Query><Where><Eq><FieldRef Name='Title'/><Value Type='Text'>${email}</Value></Eq></Where></Query></View>`);
            const items = list.getItems(q);
            ctx.load(items);
            await new Promise((res,rej)=>ctx.executeQueryAsync(res,rej));

            if(items.get_count()>0){
                const it = items.itemAt(0);
                itemId = it.get_id();
                log(`读取成功 - ID=${itemId}`);
            }else{
                const ci = new SP.ListItemCreationInformation();
                const it = list.addItem(ci);
                it.set_item("Title",email);
                it.set_item("Video1Watched",false);
                it.update();
                ctx.load(it);
                await new Promise((res,rej)=>ctx.executeQueryAsync(res,rej));
                itemId = it.get_id();
                log(`新建记录 - ID=${itemId}`);
            }
        }

        /* 标记看完 + 写库 */
        async function markWatched(){
            if(!itemId){log("还没有记录，无法更新");return;}
            const ctx = new SP.ClientContext(CFG.siteUrl);
            const list = ctx.get_web().get_lists().getByTitle(CFG.listName);
            const it = list.getItemById(itemId);
            it.set_item("Video1Watched",true);
            it.set_item("LastUpdate",new Date());
            it.update();
            await new Promise((res,rej)=>ctx.executeQueryAsync(
                ()=>{log("✅ 已标记看完，List 已更新！");res();},
                (s,a)=>{log("❌ 写库失败："+a.get_message());rej();}
            ));
        }

        /* 重置（调试用） */
        async function resetRec(){
            if(!itemId){log("暂无记录可删");return;}
            if(!confirm("确定删除自己的调试记录？"))return;
            const ctx = new SP.ClientContext(CFG.siteUrl);
            const list = ctx.get_web().get_lists().getByTitle(CFG.listName);
            list.getItemById(itemId).deleteObject();
            await new Promise((res,rej)=>ctx.executeQueryAsync(res,rej));
            itemId=0;
            log("记录已删除，请刷新页面重新生成");
        }

        /* 工具：写调试信息到页面 */
        function log(msg){
            document.getElementById("debug").innerHTML=`${new Date().toLocaleTimeString()}　${msg}`;
        }

        /* 工具：播放视频 */
        function playVideo(){document.getElementById("v").play();}
    </script>
</body>
</html>
